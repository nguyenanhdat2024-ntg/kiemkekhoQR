<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kiểm kê nhanh — Barcode Scanner</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:12px;color:#111}
    h1{font-size:20px;margin:6px 0}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:12px;align-items:start}
    .card{border:1px solid #e6e6e6;padding:10px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.03)}
    video{width:100%;height:auto;border-radius:6px;background:#000}
    label{display:block;margin-top:8px;font-size:13px}
    input[type=number],input[type=text]{width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:1px solid #ccc}
    button{padding:8px 10px;border-radius:6px;border:0;background:#1366d6;color:white;cursor:pointer}
    button.ghost{background:#f2f2f2;color:#222}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
    .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .small{font-size:12px;padding:6px 8px}
    footer{margin-top:12px;font-size:12px;color:#666}
    #log{font-size:12px;color:#a00;margin-top:8px;white-space:pre-wrap}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h1>Ứng dụng quét mã vạch + nhập số lượng</h1>
  <div class="grid">
    <div class="card">
      <video id="video" playsinline></video>
      <div class="controls">
        <select id="deviceSelect"></select>
        <button id="startBtn">Bắt đầu</button>
        <button id="stopBtn" class="ghost">Dừng</button>
      </div>

      <label>Mã gốc:</label>
      <div class="card" id="decoded" style="padding:8px;background:#fafafa;">(chưa quét)</div>

      <div class="controls">
        <input id="filterStart" type="number" min="1" value="1" style="width:80px" placeholder="Vị trí bắt đầu" />
        <input id="filterLength" type="number" min="1" value="0" style="width:80px" placeholder="Số ký tự" />
      </div>

      <label>Mã sau lọc:</label>
      <div class="card" id="filtered" style="padding:8px;background:#f0f9ff;">(chưa có)</div>

      <label>Tên sản phẩm</label>
      <input id="productName" placeholder="Tên sản phẩm (nếu có)" />

      <label>Số lượng</label>
      <div class="controls">
        <button id="dec" class="ghost small">−</button>
        <input id="qty" type="number" value="1" min="1" style="width:80px;text-align:center" />
        <button id="inc" class="ghost small">＋</button>
        <button id="addBtn">Thêm</button>
      </div>

      <div class="controls">
        <button id="clearBtn" class="ghost small">Xóa danh sách</button>
        <button id="exportBtn" class="small">Xuất CSV</button>
        <input id="importFile" type="file" accept="text/csv" style="display:none" />
        <button id="importBtn" class="small ghost">Nhập CSV</button>
      </div>

      <div id="log">(log sẽ hiển thị ở đây)</div>

      <footer>Nhớ cho phép Camera khi trình duyệt hỏi. Chạy trên HTTPS (GitHub Pages) hoặc localhost.</footer>
    </div>

    <div class="card">
      <h3>Danh sách kiểm kê</h3>
      <table id="table">
        <thead><tr><th>Mã</th><th>Tên</th><th>Số lượng</th><th>Hành động</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px">Tổng mục: <span id="count">0</span> — Tổng số lượng: <span id="total">0</span></div>
    </div>
  </div>

  <!-- ZXing library -->
  <script src="https://unpkg.com/@zxing/library@0.18.6"></script>
  <script>
    // --- DOM ---
    const video = document.getElementById('video');
    const deviceSelect = document.getElementById('deviceSelect');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const decodedEl = document.getElementById('decoded');
    const filteredEl = document.getElementById('filtered');
    const productNameInput = document.getElementById('productName');
    const qtyInput = document.getElementById('qty');
    const addBtn = document.getElementById('addBtn');
    const decBtn = document.getElementById('dec');
    const incBtn = document.getElementById('inc');
    const tableBody = document.querySelector('#table tbody');
    const countEl = document.getElementById('count');
    const totalEl = document.getElementById('total');
    const clearBtn = document.getElementById('clearBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const filterStart = document.getElementById('filterStart');
    const filterLength = document.getElementById('filterLength');
    const logEl = document.getElementById('log');

    // --- Data ---
    const inventory = new Map();
    const codeReader = new ZXing.BrowserMultiFormatReader();
    let selectedDeviceId = null;
    let lastCode='', lastTime=0;

    // --- Helpers ---
    function log(msg){ logEl.textContent = msg; }
    function escapeHtml(s){ return String(s||'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }

    function applyFilter(code){
      const start = Number(filterStart.value||1)-1;
      const len = Number(filterLength.value||0);
      if(!code) return '';
      if(len>0) return code.substr(start,len);
      return code.substr(start);
    }

    function renderTable(){
      tableBody.innerHTML='';
      let total=0;
      for(const [k,v] of inventory.entries()){
        const tr=document.createElement('tr');
        tr.innerHTML = '<td>'+escapeHtml(v.code)+'</td><td>'+escapeHtml(v.name)+'</td><td>'+v.qty+'</td><td><button data-code="'+escapeAttr(v.code)+'" class="ghost small">Xóa</button></td>';
        tableBody.appendChild(tr);
        total+=v.qty;
      }
      countEl.textContent=inventory.size;
      totalEl.textContent=total;
      tableBody.querySelectorAll('button').forEach(b=>b.addEventListener('click',ev=>{
        inventory.delete(ev.currentTarget.getAttribute('data-code'));
        renderTable();
      }));
    }

    // --- Camera ---
    async function listCameras(){
      try{
        const devices = await codeReader.listVideoInputDevices();
        deviceSelect.innerHTML='';
        devices.forEach((d,i)=>{
          const opt=document.createElement('option');
          opt.value=d.deviceId;
          opt.textContent=d.label||('Camera '+(i+1));
          deviceSelect.appendChild(opt);
        });
        if(devices.length){
          selectedDeviceId=devices[0].deviceId;
          deviceSelect.value=selectedDeviceId;
          log("Tìm thấy "+devices.length+" camera.");
        }else{
          log("Không tìm thấy camera nào.");
        }
      }catch(e){
        log("Lỗi liệt kê camera: "+e.message);
      }
    }

    function startScan(){
      if(!selectedDeviceId){ log("Chưa chọn camera."); return; }
      codeReader.decodeFromVideoDevice(selectedDeviceId, video, (result,err)=>{
        if(result){
          const code=result.text;
          const now=Date.now();
          if(code===lastCode && now-lastTime<2000) return;
          lastCode=code; lastTime=now;
          onDecoded(code);
        }
        if(err && !(err instanceof ZXing.NotFoundException)){
          log("Lỗi quét: "+err);
        }
      }).catch(e=>{
        log("Không thể mở camera: "+e.message);
      });
    }

    function stopScan(){ codeReader.reset(); log("Đã dừng camera."); }

    // --- Logic ---
    function onDecoded(code){
      decodedEl.textContent=code;
      const filtered=applyFilter(code);
      filteredEl.textContent=filtered||'(trống)';
    }

    incBtn.addEventListener('click',()=> qtyInput.value=Number(qtyInput.value||0)+1);
    decBtn.addEventListener('click',()=> qtyInput.value=Math.max(1,Number(qtyInput.value||1)-1));

    addBtn.addEventListener('click',()=>{
      const code=filteredEl.textContent && filteredEl.textContent!=='(chưa có)' ? filteredEl.textContent.trim() : null;
      const name=productNameInput.value.trim()||'(không tên)';
      const qty=Math.max(1,Math.floor(Number(qtyInput.value)||1));
      if(!code){ alert("Chưa có mã!"); return; }
      if(inventory.has(code)) inventory.get(code).qty+=qty;
      else inventory.set(code,{code,name,qty});
      renderTable();
    });

    clearBtn.addEventListener('click',()=>{ if(confirm("Xóa toàn bộ danh sách?")){ inventory.clear(); renderTable(); }});

    exportBtn.addEventListener('click',()=>{
      const rows=[['code','name','qty']];
      for(const [k,v] of inventory.entries()) rows.push([v.code,v.name,v.qty]);
      const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='inventory.csv'; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click',()=>importFile.click());
    importFile.addEventListener('change',e=>{
      const f=e.target.files[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>{
        const lines=reader.result.split('\n').map(l=>l.trim()).filter(Boolean);
        for(let i=1;i<lines.length;i++){
          const parts=lines[i].split(',').map(p=>p.replace(/^"?|"?$/g,''));
          const code=parts[0]||('imp-'+Date.now()+'-'+i);
          const name=parts[1]||'';
          const qty=Number(parts[2]||0);
          if(inventory.has(code)) inventory.get(code).qty+=qty;
          else inventory.set(code,{code,name,qty});
        }
        renderTable();
      };
      reader.readAsText(f);
    });

    // --- Events ---
    deviceSelect.addEventListener('change',()=> selectedDeviceId=deviceSelect.value);
    startBtn.addEventListener('click',()=>{ startScan(); log("Đang quét..."); });
    stopBtn.addEventListener('click',stopScan);
    filterStart.addEventListener('input',()=>{ if(lastCode) filteredEl.textContent=applyFilter(lastCode); });
    filterLength.addEventListener('input',()=>{ if(lastCode) filteredEl.textContent=applyFilter(lastCode); });

    // --- Init ---
    (async()=>{ await listCameras(); stopBtn.disabled=false; })();
  </script>
</body>
</html>
