<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="·ª®ng d·ª•ng qu√©t m√£ v·∫°ch v√† qu·∫£n l√Ω ki·ªÉm k√™ nhanh ch√≥ng, hi·ªáu qu·∫£">
  <meta name="keywords" content="qu√©t m√£ v·∫°ch, ki·ªÉm k√™, inventory, barcode scanner">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://unpkg.com; style-src 'self' 'unsafe-inline'; connect-src 'self'">
  <title>Ki·ªÉm k√™ nhanh ‚Äî Barcode Scanner</title>
  <style>
    :root {
      --primary: #1366d6;
      --primary-dark: #0d4ba3;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border: #e6e6e6;
      --shadow: 0 1px 4px rgba(0,0,0,0.03);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 12px;
      color: var(--dark);
      background-color: #f5f7fa;
      line-height: 1.5;
    }
    
    h1 {
      font-size: 22px;
      margin: 6px 0 12px;
      color: var(--primary);
    }
    
    h3 {
      margin: 0 0 12px;
      font-size: 18px;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 16px;
      align-items: start;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .card {
      border: 1px solid var(--border);
      padding: 16px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      background: white;
      margin-bottom: 12px;
    }
    
    video {
      width: 100%;
      height: auto;
      border-radius: 6px;
      background: #000;
      min-height: 200px;
    }
    
    label {
      display: block;
      margin-top: 12px;
      margin-bottom: 4px;
      font-size: 14px;
      font-weight: 500;
    }
    
    input[type=number], input[type=text], select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(19, 102, 214, 0.2);
    }
    
    button {
      padding: 10px 14px;
      border-radius: 6px;
      border: 0;
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    button:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    button.ghost {
      background: #f2f2f2;
      color: #222;
      border: 1px solid #ddd;
    }
    
    button.ghost:hover:not(:disabled) {
      background: #e6e6e6;
    }
    
    button.success {
      background: var(--success);
    }
    
    button.danger {
      background: var(--danger);
    }
    
    button.warning {
      background: var(--warning);
      color: var(--dark);
    }
    
    .small {
      font-size: 12px;
      padding: 8px 10px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }
    
    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .controls {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    footer {
      margin-top: 16px;
      font-size: 12px;
      color: var(--gray);
      text-align: center;
      padding: 8px;
    }
    
    #log {
      font-size: 13px;
      margin-top: 12px;
      white-space: pre-wrap;
      min-height: 40px;
      padding: 8px;
      border-radius: 4px;
      background: #fff9e6;
      border-left: 4px solid var(--warning);
    }
    
    .status-success {
      background: #f0f9f0;
      border-left-color: var(--success);
      color: #155724;
    }
    
    .status-error {
      background: #fdf2f2;
      border-left-color: var(--danger);
      color: #721c24;
    }
    
    .code-display {
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 16px;
      word-break: break-all;
      margin: 8px 0;
    }
    
    .code-original {
      background: #fafafa;
      border: 1px dashed #ccc;
    }
    
    .code-filtered {
      background: #f0f9ff;
      border: 1px dashed #1366d6;
      color: #1366d6;
      font-weight: 600;
    }
    
    .search-box {
      margin-bottom: 12px;
      position: relative;
    }
    
    .search-box input {
      padding-left: 36px;
    }
    
    .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }
    
    .empty-state {
      text-align: center;
      padding: 20px;
      color: var(--gray);
    }
    
    .loading {
      position: relative;
      color: transparent;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      left: calc(50% - 8px);
      top: calc(50% - 8px);
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 6px;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      transform: translateX(150%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      border-left: 4px solid var(--success);
    }
    
    .notification.error {
      border-left: 4px solid var(--danger);
    }
    
    .notification.warning {
      border-left: 4px solid var(--warning);
    }
    
    .qty-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .qty-controls input {
      width: 70px;
      text-align: center;
    }
    
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .card {
        padding: 12px;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .controls button {
        width: 100%;
      }
      
      .qty-controls {
        justify-content: center;
      }

      .qty-controls {
        display: grid;
        grid-template-columns: 50px 1fr 50px;
        gap: 8px;
        align-items: center;
      }
      
      .qty-controls input {
        width: 100%;
      }
      
      .controls.wrap-buttons {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .controls.wrap-buttons > * {
        flex-basis: 48%;
        margin-bottom: 8px;
      }
    }
  </style>
</head>
<body>
  <h1>üì¶ ·ª®ng d·ª•ng qu√©t m√£ v·∫°ch + nh·∫≠p s·ªë l∆∞·ª£ng</h1>
  
  <div class="grid">
    <div class="card">
      <video id="video" playsinline></video>
      <div class="controls">
        <select id="deviceSelect"></select>
        <button id="startBtn">üì∑ B·∫Øt ƒë·∫ßu</button>
        <button id="stopBtn" class="ghost">‚èπÔ∏è D·ª´ng</button>
      </div>

      <label>M√£ g·ªëc:</label>
      <div class="code-display code-original" id="decoded">(ch∆∞a qu√©t)</div>

      <div class="controls">
        <div>
          <label for="filterStart" style="margin-top: 0;">V·ªã tr√≠ b·∫Øt ƒë·∫ßu</label>
          <input id="filterStart" type="number" min="1" value="1" style="width: 100px" />
        </div>
        <div>
          <label for="filterLength" style="margin-top: 0;">S·ªë k√Ω t·ª±</label>
          <input id="filterLength" type="number" min="0" value="0" style="width: 100px" placeholder="0 = ƒë·∫øn cu·ªëi" />
        </div>
      </div>

      <label>M√£ sau l·ªçc:</label>
      <div class="code-display code-filtered" id="filtered">(ch∆∞a c√≥)</div>

      <label for="productName">T√™n s·∫£n ph·∫©m</label>
      <input id="productName" placeholder="T√™n s·∫£n ph·∫©m (n·∫øu c√≥)" />

      <label for="qty">S·ªë l∆∞·ª£ng</label>
      <div class="controls">
        <div class="qty-controls">
          <button id="dec" class="ghost small">‚àí</button>
          <input id="qty" type="number" value="1" min="1" />
          <button id="inc" class="ghost small">Ôºã</button>
        </div>
        <button id="addBtn" class="success">‚ûï Th√™m</button>
      </div>

      <div class="controls wrap-buttons">
        <button id="clearBtn" class="ghost small danger">üóëÔ∏è X√≥a danh s√°ch</button>
        <button id="exportBtn" class="small">üì• Xu·∫•t CSV</button>
        <input id="importFile" type="file" accept=".csv,text/csv" style="display:none" />
        <button id="importBtn" class="small ghost">üì§ Nh·∫≠p CSV</button>
      </div>

      <div id="log" class="status-success">S·∫µn s√†ng. B·∫•m "B·∫Øt ƒë·∫ßu" v√† cho ph√©p Camera.</div>
    </div>

    <div class="card">
      <h3>üìã Danh s√°ch ki·ªÉm k√™</h3>
      <div style="max-height: 400px; overflow-y: auto;">
        <table id="table">
          <thead>
            <tr>
              <th>M√£</th>
              <th>T√™n</th>
              <th>S·ªë l∆∞·ª£ng</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="4" class="empty-state">Danh s√°ch tr·ªëng</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div style="margin-top: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px;">
        T·ªïng m·ª•c: <strong id="count">0</strong> ‚Äî T·ªïng s·ªë l∆∞·ª£ng: <strong id="total">0</strong>
      </div>
    </div>
  </div>

  <footer>
    Nh·ªõ cho ph√©p Camera khi tr√¨nh duy·ªát h·ªèi. ·ª®ng d·ª•ng ch·∫°y t·ªët nh·∫•t tr√™n HTTPS (GitHub Pages) ho·∫∑c localhost.
    <br>D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ c·ª•c b·ªô trong tr√¨nh duy·ªát c·ªßa b·∫°n.
  </footer>

  <div id="notification" class="notification"></div>

  <script src="https://unpkg.com/@zxing/library@0.18.6"></script>
  <script>
    // --- DOM Elements ---
    const video = document.getElementById('video');
    const deviceSelect = document.getElementById('deviceSelect');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const decodedEl = document.getElementById('decoded');
    const filteredEl = document.getElementById('filtered');
    const productNameInput = document.getElementById('productName');
    const qtyInput = document.getElementById('qty');
    const addBtn = document.getElementById('addBtn');
    const decBtn = document.getElementById('dec');
    const incBtn = document.getElementById('inc');
    const tableBody = document.querySelector('#table tbody');
    const countEl = document.getElementById('count');
    const totalEl = document.getElementById('total');
    const clearBtn = document.getElementById('clearBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const filterStart = document.getElementById('filterStart');
    const filterLength = document.getElementById('filterLength');
    const logEl = document.getElementById('log');
    const notification = document.getElementById('notification');

    // --- Application State ---
    const inventory = new Map();
    const knownProducts = new Map();
    const codeReader = new ZXing.BrowserMultiFormatReader();
    let currentStream = null;
    let selectedDeviceId = null;
    let lastCode = '', lastTime = 0;
    let isScanning = false;
    let isAdding = false;

    // --- Utility Functions ---
    function showNotification(message, type = 'success', duration = 3000) {
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    function log(msg, type = 'status-success') {
      logEl.textContent = msg;
      logEl.className = type;
    }

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    }

    function escapeAttr(s) {
      return String(s || '').replace(/"/g, '&quot;');
    }

    function applyFilter(code) {
      const start = Math.max(0, Number(filterStart.value || 1) - 1);
      const len = Math.max(0, Number(filterLength.value || 0));
      if (!code) return '';
      if (len > 0) return code.substr(start, len);
      return code.substr(start);
    }

    function saveLocal() {
      localStorage.setItem('inventory', JSON.stringify([...inventory.values()]));
      localStorage.setItem('inventory_filter', JSON.stringify({
        start: filterStart.value,
        length: filterLength.value
      }));
      localStorage.setItem('known_products', JSON.stringify([...knownProducts.entries()]));
    }

    function loadLocal() {
      try {
        const arr = JSON.parse(localStorage.getItem('inventory') || '[]');
        inventory.clear();
        for (const v of arr) {
          if (v && v.code) inventory.set(v.code, v);
        }
        
        const filterSettings = JSON.parse(localStorage.getItem('inventory_filter') || '{}');
        if (filterSettings.start) filterStart.value = filterSettings.start;
        if (filterSettings.length !== undefined) filterLength.value = filterSettings.length;

        const knownArr = JSON.parse(localStorage.getItem('known_products') || '[]');
        knownProducts.clear();
        for (const [k, v] of knownArr) {
          knownProducts.set(k, v);
        }
      } catch (e) {
        console.warn('loadLocal error', e);
      }
    }

    function renderTable() {
      tableBody.innerHTML = '';
      let total = 0;
      let hasItems = false;
      
      for (const [k, v] of inventory.entries()) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(v.code)}</td>
          <td>${escapeHtml(v.name)}</td>
          <td>${v.qty}</td>
          <td><button data-code="${escapeAttr(v.code)}" class="ghost small danger">üóëÔ∏è X√≥a</button></td>
        `;
        tableBody.appendChild(tr);
        total += Number(v.qty) || 0;
        hasItems = true;
      }
      
      if (!hasItems) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="4" class="empty-state">Danh s√°ch tr·ªëng</td>
          </tr>
        `;
      }
      
      countEl.textContent = inventory.size;
      totalEl.textContent = total;
      
      tableBody.querySelectorAll('button').forEach(b => {
        b.addEventListener('click', ev => {
          const code = ev.currentTarget.getAttribute('data-code');
          if (confirm(`X√≥a s·∫£n ph·∫©m "${code}"?`)) {
            inventory.delete(code);
            saveLocal();
            renderTable();
            showNotification('ƒê√£ x√≥a s·∫£n ph·∫©m kh·ªèi danh s√°ch', 'success');
          }
        });
      });
    }

    // --- Camera Management ---
    function stopStream() {
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
      try {
        codeReader.reset();
      } catch (e) {
        // Ignore reset errors
      }
      video.srcObject = null;
      isScanning = false;
      stopBtn.disabled = true;
      startBtn.disabled = false;
    }

    async function listCameras() {
      try {
        const devices = await codeReader.listVideoInputDevices();
        deviceSelect.innerHTML = '';
        
        devices.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || (`Camera ${i + 1}`);
          deviceSelect.appendChild(opt);
        });
        
        if (devices.length) {
          let back = devices.find(d => /back|rear|environment/i.test(d.label));
          if (!back) back = devices[devices.length - 1];
          selectedDeviceId = back.deviceId || devices[0].deviceId;
          deviceSelect.value = selectedDeviceId;
          log(`T√¨m th·∫•y ${devices.length} camera. Ch·ªçn m·∫∑c ƒë·ªãnh: ${back ? back.label : deviceSelect.options[0].text}`);
        } else {
          log('Kh√¥ng t√¨m th·∫•y camera n√†o.', 'status-error');
        }
      } catch (e) {
        log('L·ªói li·ªát k√™ camera: ' + (e?.message || e), 'status-error');
      }
    }

    async function startScan() {
      if (isScanning) return;
      
      stopStream();
      startBtn.disabled = true;
      startBtn.innerHTML = '<span class="loading"></span> ƒêang k·∫øt n·ªëi...';
      
      try {
        const constraints = {
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
            facingMode: selectedDeviceId ? undefined : { ideal: 'environment' }
          }
        };
        
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
        
        await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play().then(resolve);
          };
        });
        
        codeReader.decodeFromVideoDevice(selectedDeviceId, video, (result, err) => {
          if (result) handleResult(result.text);
          if (err && !(err instanceof ZXing.NotFoundException)) {
            console.warn('Decode error:', err);
          }
        });
        
        isScanning = true;
        stopBtn.disabled = false;
        log('Camera ƒë√£ k·∫øt n·ªëi. ƒê∆∞a m√£ v√†o khung ƒë·ªÉ qu√©t.', 'status-success');
        
      } catch (error) {
        console.error('L·ªói k·∫øt n·ªëi camera:', error);
        log('L·ªói k·∫øt n·ªëi camera: ' + (error?.message || error), 'status-error');
        showNotification('Kh√¥ng th·ªÉ k·∫øt n·ªëi camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p.', 'error', 5000);
      } finally {
        startBtn.innerHTML = 'üì∑ B·∫Øt ƒë·∫ßu';
        startBtn.disabled = isScanning;
      }
    }

    function stopScan() {
      stopStream();
      log('ƒê√£ d·ª´ng camera.', 'status-success');
      showNotification('ƒê√£ d·ª´ng camera', 'warning');
    }

    // --- Barcode Result Handling ---
    function handleResult(code) {
      const now = Date.now();
      if (code === lastCode && now - lastTime < 1500) return;
      
      lastCode = code;
      lastTime = now;
      
      decodedEl.textContent = code;
      const filtered = applyFilter(code);
      filteredEl.textContent = filtered || '(tr·ªëng)';
      
      if (inventory.has(filtered)) {
        productNameInput.value = inventory.get(filtered).name;
      } else {
        productNameInput.value = knownProducts.get(filtered) || '';
      }
      
      productNameInput.focus();
      
      showNotification(`ƒê√£ qu√©t m√£: ${code}`, 'success', 2000);

      stopScan();
    }

    // --- Quantity Validation ---
    function validateQuantity() {
      let value = parseInt(qtyInput.value);
      if (isNaN(value) || value < 1) {
        qtyInput.value = 1;
        return 1;
      }
      return value;
    }

    // --- Event Listeners ---
    incBtn.addEventListener('click', () => {
      qtyInput.value = Number(qtyInput.value || 0) + 1;
      validateQuantity();
    });
    
    decBtn.addEventListener('click', () => {
      qtyInput.value = Math.max(1, Number(qtyInput.value || 1) - 1);
      validateQuantity();
    });
    
    qtyInput.addEventListener('change', validateQuantity);
    qtyInput.addEventListener('blur', validateQuantity);

    addBtn.addEventListener('click', () => {
      if (isAdding) return;
      
      const filteredCode = filteredEl.textContent.trim();
      if (!filteredCode || filteredCode === '(ch∆∞a c√≥)' || filteredCode === '(tr·ªëng)') {
        showNotification('Ch∆∞a c√≥ m√£ ƒë·ªÉ th√™m!', 'error');
        return;
      }

      isAdding = true;
      addBtn.disabled = true;
      
      const code = filteredCode;
      const name = productNameInput.value.trim() || '(kh√¥ng t√™n)';
      const qty = validateQuantity();
      
      if (inventory.has(code)) {
        inventory.get(code).qty += qty;
        showNotification(`ƒê√£ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng cho "${code}"`, 'success');
      } else {
        inventory.set(code, { code, name, qty });
        showNotification(`ƒê√£ th√™m s·∫£n ph·∫©m "${code}" v√†o danh s√°ch`, 'success');
      }
      
      if (name !== '(kh√¥ng t√™n)') {
        knownProducts.set(code, name);
      }
      
      saveLocal();
      renderTable();
      
      productNameInput.value = '';
      qtyInput.value = 1;

      setTimeout(() => {
        isAdding = false;
        addBtn.disabled = false;
      }, 500);
    });

    clearBtn.addEventListener('click', () => {
      if (inventory.size === 0) {
        showNotification('Danh s√°ch ƒë√£ tr·ªëng!', 'warning');
        return;
      }
      
      if (confirm(`X√≥a to√†n b·ªô ${inventory.size} m·ª•c trong danh s√°ch?`)) {
        inventory.clear();
        saveLocal();
        renderTable();
        showNotification('ƒê√£ x√≥a to√†n b·ªô danh s√°ch', 'success');
      }
    });

    exportBtn.addEventListener('click', () => {
      if (inventory.size === 0) {
        showNotification('Danh s√°ch tr·ªëng, kh√¥ng c√≥ g√¨ ƒë·ªÉ xu·∫•t!', 'warning');
        return;
      }
      
      const rows = [['M√£', 'T√™n s·∫£n ph·∫©m', 'S·ªë l∆∞·ª£ng']];
      for (const [k, v] of inventory.entries()) {
        rows.push([v.code, v.name, v.qty]);
      }
      
      const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `inventory-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      
      showNotification(`ƒê√£ xu·∫•t ${inventory.size} m·ª•c ra file CSV`, 'success');
    });

    importBtn.addEventListener('click', () => importFile.click());
    
    importFile.addEventListener('change', e => {
      const f = e.target.files[0];
      if (!f) return;
      
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const lines = reader.result.split('\n').map(l => l.trim()).filter(Boolean);
          let importedCount = 0;
          
          for (let i = 1; i < lines.length; i++) {
            const parts = splitCsvLine(lines[i]);
            if (parts.length < 3) continue;
            
            const code = parts[0]?.trim() || `imp-${Date.now()}-${i}`;
            const name = parts[1]?.trim() || '';
            const qty = Number(parts[2]) || 0;
            
            if (qty > 0) {
              if (inventory.has(code)) {
                inventory.get(code).qty += qty;
              } else {
                inventory.set(code, { code, name, qty });
              }
              importedCount++;
            }
          }
          
          saveLocal();
          renderTable();
          showNotification(`ƒê√£ nh·∫≠p ${importedCount} m·ª•c t·ª´ file CSV`, 'success');
        } catch (error) {
          showNotification('L·ªói khi ƒë·ªçc file CSV: ' + error.message, 'error');
        }
        
        importFile.value = '';
      };
      
      reader.onerror = () => {
        showNotification('L·ªói khi ƒë·ªçc file', 'error');
        importFile.value = '';
      };
      
      reader.readAsText(f);
    });

    function splitCsvLine(line) {
      const regex = /(?:,|\n|^)("(?:(?:"")*[^"]*)*"|[^",\n]*|(?:\n|$))/g;
      const result = [];
      let match;
      
      while ((match = regex.exec(line))) {
        let value = match[1] || '';
        if (value.startsWith('"') && value.endsWith('"')) {
          value = value.slice(1, -1).replace(/""/g, '"');
        }
        result.push(value);
      }
      
      return result;
    }

    deviceSelect.addEventListener('change', () => {
      selectedDeviceId = deviceSelect.value;
      if (isScanning) {
        stopScan();
      }
    });

    startBtn.addEventListener('click', startScan);
    stopBtn.addEventListener('click', stopScan);

    filterStart.addEventListener('input', () => {
      saveLocal();
      if (lastCode) filteredEl.textContent = applyFilter(lastCode);
    });
    
    filterLength.addEventListener('input', () => {
      saveLocal();
      if (lastCode) filteredEl.textContent = applyFilter(lastCode);
    });

    productNameInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        addBtn.click();
      }
    });
    
    qtyInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        addBtn.click();
      }
    });

    // --- Initialize Application ---
    (async function init() {
      notification.innerHTML = '‚ìò ';
      
      try {
        await listCameras();
      } catch (e) {
        console.warn('Init listCameras error:', e);
      }
      
      loadLocal();
      renderTable();
      
      stopBtn.disabled = true;
      
      log('·ª®ng d·ª•ng ƒë√£ s·∫µn s√†ng. B·∫•m "B·∫Øt ƒë·∫ßu" ƒë·ªÉ qu√©t m√£ v·∫°ch.', 'status-success');
      
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        log('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ truy c·∫≠p camera.', 'status-error');
        startBtn.disabled = true;
      }
    })();

    // Clean up on page unload
    window.addEventListener('pagehide', stopStream);
    window.addEventListener('beforeunload', stopStream);
  </script>
</body>
</html>
