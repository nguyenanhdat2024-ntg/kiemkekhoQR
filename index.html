<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ứng dụng kiểm kê nhanh</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:12px;color:#111}
    h1{font-size:20px;margin:6px 0}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:12px;align-items:start}
    .card{border:1px solid #e6e6e6;padding:10px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.03)}
    video{width:100%;height:auto;border-radius:6px;background:#000}
    label{display:block;margin-top:8px;font-size:13px}
    input[type=number],input[type=text]{width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:1px solid #ccc}
    button{padding:8px 10px;border-radius:6px;border:0;background:#1366d6;color:white;cursor:pointer}
    button.ghost{background:#f2f2f2;color:#222}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
    .controls{display:flex;gap:8px;margin-top:8px}
    .small{font-size:12px;padding:6px 8px}
    footer{margin-top:12px;font-size:12px;color:#666}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h1>Ứng dụng kiểm kê nhanh</h1>
  <div class="grid">
    <!-- Bên trái: Quét và nhập -->
    <div class="card">
      <video id="video" playsinline></video>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <select id="deviceSelect"></select>
        <button id="startBtn">Bắt đầu</button>
        <button id="stopBtn" class="ghost">Dừng</button>
      </div>

      <label>Mã quét được:</label>
      <div class="card" id="decoded" style="padding:8px;background:#fafafa;">(chưa quét)</div>

      <label>Thông tin sản phẩm (tùy chọn)</label>
      <input id="productName" placeholder="Tên sản phẩm" />

      <label>Số lượng</label>
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
        <button id="dec" class="ghost small">−</button>
        <input id="qty" type="number" inputmode="numeric" value="1" min="1" style="width:80px;text-align:center" />
        <button id="inc" class="ghost small">＋</button>
        <button id="addBtn">Thêm vào kiểm kê</button>
      </div>

      <div style="margin-top:8px">
        <button id="clearBtn" class="ghost small">Xóa danh sách</button>
        <button id="exportBtn" class="small">Xuất CSV</button>
        <input id="importFile" type="file" accept="text/csv" style="display:none" />
        <button id="importBtn" class="small ghost">Nhập CSV</button>
      </div>

      <footer>
        Cho phép camera khi trình duyệt hỏi. Chrome/Safari trên điện thoại hỗ trợ tốt.
      </footer>
    </div>

    <!-- Bên phải: Danh sách -->
    <div class="card">
      <h3>Danh sách kiểm kê</h3>
      <table id="table">
        <thead><tr><th>Mã</th><th>Tên</th><th>Số lượng</th><th>Hành động</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px">Tổng mục: <span id="count">0</span> — Tổng số lượng: <span id="total">0</span></div>

      <hr />
      <h4>Danh mục mẫu</h4>
      <div id="catalog" style="font-size:13px;color:#333"></div>

      <h4>Bộ lọc theo mã (tự động khi quét)</h4>
      <div style="display:flex;gap:8px;align-items:center;font-size:13px;margin-bottom:6px">
        <label>Bắt đầu: <input id="startPos" type="number" value="1" min="1" style="width:60px"></label>
        <label>Ký tự: <input id="lengthPos" type="number" value="3" min="1" style="width:60px"></label>
      </div>
      <div id="filterResult" style="font-size:13px;color:#444;background:#fafafa;padding:6px;border-radius:6px;">
        (Chưa quét)
      </div>
    </div>
  </div>

  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@0.18.6"></script>
  <script>
  // ==== DATA ====
  const CATALOG = {
    '8938500000012':'Giấy A4 70gsm 500t',
    '8938500000029':'Bút bi xanh',
    '8938500000036':'Bút bi đen',
    '8938500000043':'Sổ tay A5'
  };
  const inventory = new Map();

  // ==== DOM ====
  const video = document.getElementById('video');
  const deviceSelect = document.getElementById('deviceSelect');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const decodedEl = document.getElementById('decoded');
  const productNameInput = document.getElementById('productName');
  const qtyInput = document.getElementById('qty');
  const addBtn = document.getElementById('addBtn');
  const decBtn = document.getElementById('dec');
  const incBtn = document.getElementById('inc');
  const tableBody = document.querySelector('#table tbody');
  const countEl = document.getElementById('count');
  const totalEl = document.getElementById('total');
  const clearBtn = document.getElementById('clearBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');
  const catalogEl = document.getElementById('catalog');
  const startPos = document.getElementById('startPos');
  const lengthPos = document.getElementById('lengthPos');
  const filterResult = document.getElementById('filterResult');

  // ==== CAMERA/SCAN ====
  const codeReader = new ZXing.BrowserMultiFormatReader();
  let selectedDeviceId = null;
  let lastCode = '', lastTime = 0;

  async function listCameras(){
    const devices = await codeReader.listVideoInputDevices();
    deviceSelect.innerHTML='';
    devices.forEach((d,i)=>{
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = d.label || ('Camera ' + (i+1));
      deviceSelect.appendChild(opt);
    });
    if(devices.length) selectedDeviceId = devices[0].deviceId;
  }

  function startScan(){
    codeReader.decodeFromVideoDevice(selectedDeviceId, video, (result, err)=>{
      if(result){
        const code = result.text;
        const now = Date.now();
        if(code === lastCode && now - lastTime < 2000) return; // tránh lặp
        lastCode = code; lastTime = now;
        onDecoded(code);
      }
    });
  }

  function stopScan(){ codeReader.reset(); }

  // ==== INVENTORY ====
  function addToInventory(code, name, qty){
    const key = code || ('manual-' + Date.now());
    const existing = inventory.get(key);
    if(existing){ existing.qty += qty; if(name) existing.name = name; }
    else inventory.set(key, {code:key, name: name||CATALOG[key]||'(không tên)', qty});
    renderTable();
  }

  function renderTable(){
    tableBody.innerHTML='';
    let total=0;
    for(const [k,v] of inventory.entries()){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${escapeHtml(v.code)}</td>
                    <td>${escapeHtml(v.name)}</td>
                    <td>${v.qty}</td>
                    <td><button data-code="${escapeAttr(v.code)}" class="ghost small">Xóa</button></td>`;
      tableBody.appendChild(tr);
      total+=v.qty;
    }
    countEl.textContent=inventory.size;
    totalEl.textContent=total;
    tableBody.querySelectorAll('button').forEach(b=>b.addEventListener('click',ev=>{
      const code=ev.currentTarget.getAttribute('data-code');
      inventory.delete(code); renderTable();
    }));
    saveInventory();
  }

  // ==== CSV ====
  function exportCSV(){
    const rows=[['code','name','qty']];
    for(const [k,v] of inventory.entries()) rows.push([v.code,v.name,v.qty]);
    const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download='inventory.csv';a.click();
    URL.revokeObjectURL(url);
  }

  function importCSV(txt){
    const lines=txt.split('\n').map(l=>l.trim()).filter(Boolean);
    for(let i=1;i<lines.length;i++){
      const parts=lines[i].split(',').map(p=>p.replace(/^\s*"?/,'').replace(/"?\s*$/,''));
      const code=parts[0]||('imp-'+Date.now()+'-'+i);
      const name=parts[1]||'';
      const qty=Number(parts[2]||0);
      if(inventory.has(code)) inventory.get(code).qty+=qty;
      else inventory.set(code,{code,name,qty});
    }
    renderTable();
  }

  // ==== CATALOG ====
  function renderCatalog(){
    catalogEl.innerHTML=Object.keys(CATALOG)
      .map(k=>`<div><strong>${k}</strong> — ${CATALOG[k]}</div>`).join('');
  }

  // ==== FILTER ====
  function applyFilterToCode(code){
    const start=Math.max(1,Number(startPos.value||1));
    const len=Math.max(1,Number(lengthPos.value||1));
    const sub=code.substring(start-1,start-1+len);
    filterResult.innerHTML=`<div><strong>${code}</strong> → "${sub}"</div>`;
  }

  // ==== HELPERS ====
  function escapeHtml(s){ return String(s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
  function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }

  function saveInventory(){ localStorage.setItem('inventory', JSON.stringify([...inventory])); }
  function loadInventory(){
    const data=JSON.parse(localStorage.getItem('inventory')||'[]');
    for(const [k,v] of data) inventory.set(k,v);
    renderTable();
  }

  // ==== EVENT ====
  function bindEvents(){
    deviceSelect.addEventListener('change',()=>selectedDeviceId=deviceSelect.value);
    startBtn.addEventListener('click',()=>{ startScan(); startBtn.disabled=true; stopBtn.disabled=false; });
    stopBtn.addEventListener('click',()=>{ stopScan(); startBtn.disabled=false; stopBtn.disabled=true; });
    incBtn.addEventListener('click',()=>qtyInput.value=Number(qtyInput.value||0)+1);
    decBtn.addEventListener('click',()=>qtyInput.value=Math.max(1,Number(qtyInput.value||1)-1));
    addBtn.addEventListener('click',()=>{
      const code=decodedEl.textContent && decodedEl.textContent!=='(chưa quét)'?decodedEl.textContent.trim():null;
      const name=productNameInput.value.trim();
      const qty=Math.max(1,Math.floor(Number(qtyInput.value)||1));
      if(!code && !confirm('Chưa có mã. Thêm thủ công?')) return;
      addToInventory(code,name,qty);
      qtyInput.value=1; // reset
    });
    clearBtn.addEventListener('click',()=>{ if(confirm('Xóa toàn bộ?')){ inventory.clear(); renderTable(); } });
    exportBtn.addEventListener('click',exportCSV);
    importBtn.addEventListener('click',()=>importFile.click());
    importFile.addEventListener('change',e=>{
      const f=e.target.files[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>{ importCSV(reader.result); importFile.value=''; };
      reader.readAsText(f);
    });
  }

  // ==== MAIN ====
  function onDecoded(code){
    decodedEl.textContent=code;
    if(CATALOG[code]) productNameInput.value=CATALOG[code];
    applyFilterToCode(code); // lọc ngay
  }

  async function init(){
    renderCatalog();
    await listCameras();
    stopBtn.disabled=true;
    loadInventory();
    bindEvents();
  }

  init();
  </script>
</body>
</html>
