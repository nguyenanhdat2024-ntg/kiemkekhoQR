<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ki·ªÉm k√™ nhanh ‚Äî Barcode Scanner</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:12px;color:#111}
    h1{font-size:20px;margin:6px 0}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:12px;align-items:start}
    .card{border:1px solid #e6e6e6;padding:10px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.03)}
    video{width:100%;height:auto;border-radius:6px;background:#000}
    label{display:block;margin-top:8px;font-size:13px}
    input[type=number],input[type=text]{width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:1px solid #ccc}
    button{padding:8px 10px;border-radius:6px;border:0;background:#1366d6;color:white;cursor:pointer}
    button.ghost{background:#f2f2f2;color:#222}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
    .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .small{font-size:12px;padding:6px 8px}
    footer{margin-top:12px;font-size:12px;color:#666}
    #log{font-size:12px;color:#a00;margin-top:8px;white-space:pre-wrap}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <h1>·ª®ng d·ª•ng qu√©t m√£ v·∫°ch + nh·∫≠p s·ªë l∆∞·ª£ng</h1>
  <div class="grid">
    <div class="card">
      <video id="video" playsinline></video>
      <div class="controls">
        <select id="deviceSelect"></select>
        <button id="startBtn">B·∫Øt ƒë·∫ßu</button>
        <button id="stopBtn" class="ghost">D·ª´ng</button>
      </div>

      <label>M√£ g·ªëc:</label>
      <div class="card" id="decoded" style="padding:8px;background:#fafafa;">(ch∆∞a qu√©t)</div>

      <div class="controls">
        <input id="filterStart" type="number" min="1" value="1" style="width:80px" placeholder="V·ªã tr√≠ b·∫Øt ƒë·∫ßu" />
        <input id="filterLength" type="number" min="1" value="0" style="width:80px" placeholder="S·ªë k√Ω t·ª±" />
      </div>

      <label>M√£ sau l·ªçc:</label>
      <div class="card" id="filtered" style="padding:8px;background:#f0f9ff;">(ch∆∞a c√≥)</div>

      <label>T√™n s·∫£n ph·∫©m</label>
      <input id="productName" placeholder="T√™n s·∫£n ph·∫©m (n·∫øu c√≥)" />

      <label>S·ªë l∆∞·ª£ng</label>
      <div class="controls">
        <button id="dec" class="ghost small">‚àí</button>
        <input id="qty" type="number" value="1" min="1" style="width:80px;text-align:center" />
        <button id="inc" class="ghost small">Ôºã</button>
        <button id="addBtn">Th√™m</button>
      </div>

      <div class="controls">
        <button id="clearBtn" class="ghost small">X√≥a danh s√°ch</button>
        <button id="exportBtn" class="small">Xu·∫•t CSV</button>
        <input id="importFile" type="file" accept="text/csv" style="display:none" />
        <button id="importBtn" class="small ghost">Nh·∫≠p CSV</button>
      </div>

      <div id="log">(log s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y)</div>

      <footer>Ch·∫°y tr√™n HTTPS ho·∫∑c localhost. Cho ph√©p Camera khi tr√¨nh duy·ªát h·ªèi.</footer>
    </div>

    <div class="card">
      <h3>Danh s√°ch ki·ªÉm k√™</h3>
      <table id="table">
        <thead><tr><th>M√£</th><th>T√™n</th><th>S·ªë l∆∞·ª£ng</th><th>H√†nh ƒë·ªông</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px">T·ªïng m·ª•c: <span id="count">0</span> ‚Äî T·ªïng s·ªë l∆∞·ª£ng: <span id="total">0</span></div>
    </div>
  </div>

  <script src="https://unpkg.com/@zxing/library@0.18.6"></script>
  <script>
    const video=document.getElementById('video'),deviceSelect=document.getElementById('deviceSelect'),
    startBtn=document.getElementById('startBtn'),stopBtn=document.getElementById('stopBtn'),
    decodedEl=document.getElementById('decoded'),filteredEl=document.getElementById('filtered'),
    productNameInput=document.getElementById('productName'),qtyInput=document.getElementById('qty'),
    addBtn=document.getElementById('addBtn'),decBtn=document.getElementById('dec'),incBtn=document.getElementById('inc'),
    tableBody=document.querySelector('#table tbody'),countEl=document.getElementById('count'),
    totalEl=document.getElementById('total'),clearBtn=document.getElementById('clearBtn'),
    exportBtn=document.getElementById('exportBtn'),importBtn=document.getElementById('importBtn'),
    importFile=document.getElementById('importFile'),filterStart=document.getElementById('filterStart'),
    filterLength=document.getElementById('filterLength'),logEl=document.getElementById('log');

    const inventory=new Map();const codeReader=new ZXing.BrowserMultiFormatReader();
    let selectedDeviceId=null,lastCode='',lastTime=0;

    function log(msg){logEl.textContent=msg;}
    function escapeHtml(s){return String(s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}
    function escapeAttr(s){return String(s||'').replace(/"/g,'&quot;');}

    function applyFilter(code){
      const start=Number(filterStart.value||1)-1,len=Number(filterLength.value||0);
      if(!code)return'';return len>0?code.substr(start,len):code.substr(start);
    }

    function saveInventory(){localStorage.setItem("inventory",JSON.stringify([...inventory.entries()]));}
    function loadInventory(){
      const data=localStorage.getItem("inventory");
      if(data){const arr=JSON.parse(data);inventory.clear();arr.forEach(([k,v])=>inventory.set(k,v));renderTable();}
    }

    function renderTable(){
      tableBody.innerHTML='';let total=0;
      for(const [k,v] of inventory.entries()){
        const tr=document.createElement('tr');
        tr.innerHTML='<td>'+escapeHtml(v.code)+'</td><td>'+escapeHtml(v.name)+'</td><td>'+v.qty+'</td><td><button data-code="'+escapeAttr(v.code)+'" class="ghost small">X√≥a</button></td>';
        tableBody.appendChild(tr);total+=v.qty;
      }
      countEl.textContent=inventory.size;totalEl.textContent=total;
      tableBody.querySelectorAll('button').forEach(b=>b.addEventListener('click',ev=>{
        inventory.delete(ev.currentTarget.getAttribute('data-code'));renderTable();
      }));
      saveInventory();
    }

    async function listCameras(){
      try{
        const devices=await codeReader.listVideoInputDevices();deviceSelect.innerHTML='';
        devices.forEach((d,i)=>{const opt=document.createElement('option');opt.value=d.deviceId;opt.textContent=d.label||('Camera '+(i+1));deviceSelect.appendChild(opt);});
        if(devices.length){selectedDeviceId=devices[0].deviceId;deviceSelect.value=selectedDeviceId;log("T√¨m th·∫•y "+devices.length+" camera.");}
        else log("Kh√¥ng t√¨m th·∫•y camera n√†o.");
      }catch(e){log("L·ªói li·ªát k√™ camera: "+e.message);}
    }

    async function startScan(){
      try{
        stopScan();
        const devices=await codeReader.listVideoInputDevices();
        if(devices.length===0){log("üö´ Kh√¥ng t√¨m th·∫•y camera.");return;}
        let backCamera=devices.find(d=>/back|rear/i.test(d.label));
        if(!backCamera) backCamera=devices[devices.length-1];
        selectedDeviceId=deviceSelect.value||backCamera.deviceId;
        log("üé• ƒêang m·ªü camera...");
        await codeReader.decodeFromVideoDevice(selectedDeviceId,video,(result,err)=>{
          if(result){const code=result.text,now=Date.now();
            if(code===lastCode&&now-lastTime<2000)return;
            lastCode=code;lastTime=now;onDecoded(code);log("‚úÖ Qu√©t ƒë∆∞·ª£c: "+code);}
          if(err&&!(err instanceof ZXing.NotFoundException)) log("‚ùå L·ªói qu√©t: "+err);
        });
      }catch(e){log("üö´ Kh√¥ng th·ªÉ m·ªü camera: "+e.message);}
    }

    function stopScan(){codeReader.reset();log("ƒê√£ d·ª´ng camera.");}
    function onDecoded(code){decodedEl.textContent=code;filteredEl.textContent=applyFilter(code)||'(tr·ªëng)';}

    incBtn.addEventListener('click',()=>qtyInput.value=Number(qtyInput.value||0)+1);
    decBtn.addEventListener('click',()=>qtyInput.value=Math.max(1,Number(qtyInput.value||1)-1));

    addBtn.addEventListener('click',()=>{
      const code=filteredEl.textContent&&filteredEl.textContent!=='(ch∆∞a c√≥)'?filteredEl.textContent.trim():null;
      const name=productNameInput.value.trim()||'(kh√¥ng t√™n)';
      const qty=Math.max(1,Math.floor(Number(qtyInput.value)||1));
      if(!code){alert("Ch∆∞a c√≥ m√£!");return;}
      if(inventory.has(code))inventory.get(code).qty+=qty;
      else inventory.set(code,{code,name,qty});
      renderTable();
    });

    clearBtn.addEventListener('click',()=>{if(confirm("X√≥a to√†n b·ªô danh s√°ch?")){inventory.clear();renderTable();}});

    exportBtn.addEventListener('click',()=>{
      const rows=[['code','name','qty']];
      for(const [k,v] of inventory.entries())rows.push([v.code,v.name,v.qty]);
      const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');a.href=url;a.download='inventory.csv';
      document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click',()=>importFile.click());
    importFile.addEventListener('change',e=>{
      const f=e.target.files[0];if(!f)return;
      const reader=new FileReader();
      reader.onload=()=>{
        const lines=reader.result.split('\n').map(l=>l.trim()).filter(Boolean);
        for(let i=1;i<lines.length;i++){
          const parts=lines[i].split(',').map(p=>p.replace(/^"?|"?$/g,''));
          const code=parts[0]||('imp-'+Date.now()+'-'+i);
          const name=parts[1]||'';const qty=Number(parts[2]||0);
          if(inventory.has(code))inventory.get(code).qty+=qty;
          else inventory.set(code,{code,name,qty});
        }
        renderTable();
      };reader.readAsText(f);
    });

    deviceSelect.addEventListener('change',()=>selectedDeviceId=deviceSelect.value);
    startBtn.addEventListener('click',()=>{startScan();log("ƒêang qu√©t...");});
    stopBtn.addEventListener('click',stopScan);
    filterStart.addEventListener('input',()=>{if(lastCode)filteredEl.textContent=applyFilter(lastCode);});
    filterLength.addEventListener('input',()=>{if(lastCode)filteredEl.textContent=applyFilter(lastCode);});

    (async()=>{await listCameras();stopBtn.disabled=false;loadInventory();})();
  </script>
</body>
</html>
